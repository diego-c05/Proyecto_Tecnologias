<div class="page">
  <header class="page-header">
    <div>
      <h1>Reporte de horas</h1>
      <p class="subtitle">Panel administrativo · Reporte de horas por estudiante</p>
    </div>

    <div class="header-actions">
      <a class="btn btn-ghost" routerLink="/admin/reporte-eventos">Ver reporte de eventos</a>
    </div>
  </header>

  <section *ngIf="cargando" class="card" style="padding: 14px;">
    Cargando reporte...
  </section>

  <section *ngIf="!cargando && errorMsg" class="card" style="padding: 14px;">
    {{ errorMsg }}
  </section>

  <section class="stats" *ngIf="!cargando && !errorMsg">
    <div class="card stat">
      <p class="stat-label">Estudiantes registrados</p>
      <p class="stat-value">{{ totalEstudiantesRegistrados }}</p>
      <p class="stat-note">Usuarios con rol usuario</p>
    </div>

    <div class="card stat">
      <p class="stat-label">Estudiantes con horas de vinculación completas</p>
      <p class="stat-value">{{ totalEstudiantesCompletas }}</p>
      <p class="stat-note">Cumplieron el requisito</p>
    </div>

    <div class="card stat">
      <p class="stat-label">Estudiantes con horas de vinculación faltantes</p>
      <p class="stat-value">{{ totalEstudiantesPendientes }}</p>
      <p class="stat-note">Aún no completan las horas</p>
    </div>
  </section>

  <section class="card filters" *ngIf="!cargando && !errorMsg">
    <div class="card-header">
      <h2>Filtros</h2>
    </div>

    <div class="filters-grid">
      <div class="field">
        <label>Buscar estudiante</label>
        <input
          type="text"
          placeholder="Ej: usuarioprueba"
          [(ngModel)]="filtroNombre"
          (ngModelChange)="aplicarFiltros()"
        />
      </div>

      <div class="field">
        <label>Horas totales</label>
        <input
          type="number"
          placeholder="Ej: 20"
          [(ngModel)]="filtroHorasTotales"
          (ngModelChange)="aplicarFiltros()"
        />
      </div>

      <div class="field">
        <label>Horas restantes</label>
        <input
          type="number"
          placeholder="Ej: 10"
          [(ngModel)]="filtroHorasRestantes"
          (ngModelChange)="aplicarFiltros()"
        />
      </div>
    </div>

    <div class="filters-actions-row">
      <button class="btn btn-light" type="button" (click)="limpiarFiltros()">
        Limpiar
      </button>
    </div>
  </section>

  <hr class="divider" />


  <section class="card table-card" *ngIf="!cargando && !errorMsg">
    <div class="table-head">
      <h2 class="section-title">Historial de horas de vinculación de estudiantes</h2>
    </div>

    <div class="table-wrap">
      <table class="table">
        <thead>
          <tr>
            <th>Estudiante</th>
            <th>Total de horas registradas</th>
            <th class="col-actions">Detalles</th>
          </tr>
        </thead>

        <tbody>
          <tr *ngFor="let s of historial; trackBy: trackByUid">
            <td>
              <div class="student">
                <div class="student-name">{{ s.nombreUsuario }}</div>
                <div class="student-desc">Historial de participación en vinculación</div>
              </div>
            </td>

            <td>
              <span class="pill pill-primary">{{ s.totalHoras }}</span>
            </td>

            <td class="col-actions">
              <button class="btn btn-ghost btn-sm" type="button" (click)="abrirHistorial(s)">
                Ver historial del estudiante
              </button>
            </td>
          </tr>

          <tr *ngIf="!historial || historial.length === 0">
            <td colspan="3" class="empty empty-center">No hay resultados con esos filtros.</td>
          </tr>
        </tbody>
      </table>
    </div>
  </section>

  <section class="card table-card" *ngIf="!cargando && !errorMsg">
    <div class="table-head">
      <h2 class="section-title">Estudiantes pendientes de horas de vinculación</h2>
      <span class="badge badge-warning">Pendientes</span>
    </div>

    <div class="table-wrap">
      <table class="table">
        <thead>
          <tr>
            <th>Estudiante</th>
            <th>Total de horas</th>
            <th>Horas faltantes</th>
            <th class="col-actions">Detalles</th>
          </tr>
        </thead>

        <tbody>
          <tr *ngFor="let s of pendientes; trackBy: trackByUid">
            <td>
              <div class="student">
                <div class="student-name">{{ s.nombreUsuario }}</div>
                <div class="student-desc">Pendiente de horas</div>
              </div>
            </td>

            <td><span class="pill pill-primary">{{ s.totalHoras }}</span></td>
            <td><span class="pill pill-neutral">{{ s.horasFaltantes }}</span></td>

            <td class="col-actions">
              <button class="btn btn-ghost btn-sm" type="button" (click)="abrirHistorial(s)">
                Ver historial del estudiante
              </button>
            </td>
          </tr>

          <tr *ngIf="!pendientes || pendientes.length === 0">
            <td colspan="4" class="empty empty-center">
              No hay estudiantes con horas de vinculación faltantes.
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </section>

  <section class="card table-card" *ngIf="!cargando && !errorMsg">
    <div class="table-head">
      <h2 class="section-title">Estudiantes con horas de vinculación completas</h2>
      <span class="badge badge-success">Completas</span>
    </div>

    <div class="table-wrap">
      <table class="table">
        <thead>
          <tr>
            <th>Estudiante</th>
            <th>Total de horas</th>
            <th>Horas faltantes</th>
            <th class="col-actions">Detalles</th>
          </tr>
        </thead>

        <tbody>
          <tr *ngFor="let s of completas; trackBy: trackByUid">
            <td>
              <div class="student">
                <div class="student-name">{{ s.nombreUsuario }}</div>
                <div class="student-desc">Horas completadas</div>
              </div>
            </td>

            <td><span class="pill pill-primary">{{ s.totalHoras }}</span></td>
            <td><span class="pill pill-neutral">{{ s.horasFaltantes }}</span></td>

            <td class="col-actions">
              <button class="btn btn-ghost btn-sm" type="button" (click)="abrirHistorial(s)">
                Ver historial del estudiante
              </button>
            </td>
          </tr>

          <tr *ngIf="!completas || completas.length === 0">
            <td colspan="4" class="empty empty-center">
              No hay estudiantes con horas de vinculación completas.
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </section>

  <footer class="footer">
    <span>Gestión de horas de vinculación</span>
    <span class="dot">•</span>
    <span>Reporte administrativo</span>
  </footer>

  <div *ngIf="modalAbierto" class="modal-overlay" (click)="cerrarHistorial()">
    <div class="modal" (click)="$event.stopPropagation()">
      <div class="card" style="padding: 16px;">
        <div class="modal-header">
          <div>
            <h2 class="section-title" style="margin: 0;">Historial del estudiante</h2>
            <p class="subtitle" style="margin: 4px 0 0;">{{ modalEstudianteNombre }}</p>
          </div>

          <button class="btn btn-light btn-sm" type="button" (click)="cerrarHistorial()">
            Cerrar
          </button>
        </div>

        <div class="table-wrap" style="margin-top: 12px;">
          <table class="table">
            <thead>
              <tr>
                <th>Evento</th>
                <th>Materia</th>
                <th>Fecha</th>
                <th>Horas</th>
                <th>Estado</th>
              </tr>
            </thead>

            <tbody>
              <tr *ngFor="let h of historialEventos; trackBy: trackByHistorial">
                <td>{{ h.eventoNombre }}</td>
                <td>{{ h.materiaNombre }}</td>
                <td>{{ h.eventoFecha }}</td>
                <td><span class="pill pill-primary">{{ h.eventoHoras }}</span></td>
                <td>
                  <span
                    class="badge"
                    [ngClass]="{
                      'badge-success': (h.estado || '').toLowerCase() !== 'cancelado',
                      'badge-warning': (h.estado || '').toLowerCase() === 'cancelado'
                    }"
                  >
                    {{ h.estado }}
                  </span>
                </td>
              </tr>

              <tr *ngIf="!historialEventos || historialEventos.length === 0">
                <td colspan="5" class="empty empty-center">Este estudiante no tiene inscripciones.</td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="modal-total" style="margin-top: 14px; display:flex; justify-content:flex-end; gap:10px; align-items:center;">
          <span class="badge badge-success">Total</span>
          <span class="pill pill-neutral">{{ totalHorasHistorial }}</span>
        </div>
      </div>
    </div>
  </div>
</div>